---
title: 01.重构-介绍
comments: true
tags:
  - 编程思想
  - 重构
categories:
  - 05.编程思想
  - 02.重构
date: 2018-05-29 18:06:26
---

## 1. 定义

- 重构（refactoring）是在不改变软件可观察行为的前提下改善其内部结构。
- 重构是这样一个过程：在不改变代码外在行为的前提下，对代码进行修改，以改进程序的内部结构。
- 重构（名词）：对软件内部结构的一种调整，目的是在不改变软件可观察行为的前提下，提高可理解性，降低其修改成本。
- 重构（动词）：使用一系列重构首发，在不改变软件可观察行为的前提下，调整其结构。

<!--more-->

## 2. 原则

- 不改变软件行为只是重构的最基本要求；
- 不需了解软件行为才是目的；
- 个人理解：封装完整性？调用 API 而无需了解 API 内部实现和行为。
- 设计模式为重构提供了目标；

## 3. 目的

- 重构改进软件设计
  - 消除重复代码
- 重构使软件更容易理解
- 重构帮助找到 bug
- 重构提高编程速度

## 4. 经验

- 重构前需建立一组可靠的测试环境，且必须能自我检验；
- 重构技术就是以微小的步伐修改程序，如果出错，可以很容易发现；
- 良好的名称是代码清晰的关键；
- 尽量除去临时变量；
- 最好不要在另一个对象的属性基础上运用 switch 语句，如果不得不使用，也应该在对象自己的数据上使用，而不是在别人的数据上使用；
- 技术复审是减少错误、提高开发速度的一条重要途径。

## 5. 何时重构

- 反对专门拨出时间进行重构；
- 重构应该随时随地进行；
- 不应该为了重构而重构；
- 三次法则（事不过三，三则重构）
  - 第一次做某件事时只管去做；
  - 第二次做类似的事会产生反感，但无论如何还是可以去做；
  - 第三次再做类似的事，就应该重构。
- 添加功能时重构；
- 修补错误时重构；
- 复审代码时重构；

## 6. 为什么重构有用 -- Kent Beck

### 6.1 问题

- 难以阅读的程序，难以修改；
- 逻辑重复的程序，难以修改；
- 添加新行为时需要修改已有代码的程序，难以修改；
- 带复杂条件逻辑的程序，难以修改；

### 6.2 期望

- 容易阅读；
- 所有逻辑都只在唯一地点指定；
- 新的改动不会危及现有行为；
- 尽可能简单表达条件逻辑；

## 7. 间接层

{% blockquote Dennis DeBruler %}
计算机科学是这样一门科学：它相信所有问题都可以通过增加一个间接层来解决。
{% endblockquote %}

## 8. 重构难题

### 8.1 数据库

- 绝大多数程序都与其背后的数据库结构紧密耦合在一起；
- 数据迁移（migration）；
- 在非对象数据库中，解决办法之一是：在对象模型和数据库模型之间插入一个分割层，隔离两个模型各自的编号；

### 8.2 修改接口

只有当需要修改的接口被哪些“找不到，即使找到也不能修改”的代码使用时，接口的修改才会成为问题。此时，这个接口是个已发布接口（published interface），比公开接口（public interface）更进一步。

- 必须同时维护新旧两个接口，直到所有用户都有时间对这个变化做出反应；
  - 让旧接口调用新接口，千万不要复制函数实现；
  - 将旧接口标记为 deprecated（java 的已过时），例如 Java 容器类；
- 尽量不要发布接口，除非真的有必要；
- Java 还有一种特别的接口修改：在 throws 子句中增加一个异常。此时，需要新建函数，然后在旧函数调用它，并处理这个异常。

`ps:`不要过早发布接口。请修改你的代码所有权政策，使重构更顺畅。

### 8.3 难以通过重构手法完成的设计改动

先想象重构的情况，考虑候选设计方案难度，而后在设计上投入更多力气。

## 9. 何时不该重构

- 有时候代码是在太混乱，重构还不如重新重写一个；
- 重写（而非重构）的一个清楚讯号就是：现有代码根本不能正常运作；
- 折中办法：将“大块头软件”重构为封装良好的小型组件；
- 项目已近最后期限，此刻应该避免重构；

## 其他

### 示例

- Replace Type Code with State/Strategy
- Move Method
- Replace Conditional with Polymorphism
- Form Template Method
- Replace Temp with Query
- Extract Method
- Self Encapsulate(自封装) Field

### 重构 vs 性能优化

类型|重构|性能优化
----|----|----
内部结构|改变|改变
外部行为|不改变或很小改变|不改变（除了执行速度）
目的|软件更容易被理解和修改，性能没有变化|性能提升，但往往使代码较难理解

### 观点

- **怎么对经理说重构**：很多经理嘴巴上说自己“质量驱动”，实际是“进度驱动”，这种情况建议是：不要告诉经理！
- 学习一种可以大幅提高生产力的新技术时，你总是难以察觉其不适用的场合。通常你在一个特定场景中学习它，这个场景往往是个项目。这种情况下你很难看出什么会造成这种新技术成效不彰或形成危害。
- {% blockquote Ward Cunningham %}
  他把未完成的重构工作形容为“债务”。很多公司都需要借债来使自己更有效的运转，但借债就得付利息，过于复杂的代码所造成的维护和扩展的额外成本就是利息。你可以承受一定程度的利息，但如果利息太高，你就会被压垮。把债务管理好是很重要的，你应该随时通过重构来偿还一部分债务。
  {% endblockquote %}


## 参考

- 《重构-改善既有代码的设计》（第1-4章）
